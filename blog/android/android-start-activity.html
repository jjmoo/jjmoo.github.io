<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Android7.0 Activity启动流程与App冷启动时间测试源码分析 | 汲墨 | Zohn的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. Activity启动流程-整体概况本文只分析从Launcher冷启动一个App时，启动第一个Activity的过程，暂不考虑其他情况。从Launcher点击应用图标到App第一个Activity启动完毕，期间主要涉及到四个进程：

Launcher
ActivityManagerService
Zygote
App">
<meta property="og:type" content="article">
<meta property="og:title" content="Android7.0 Activity启动流程与App冷启动时间测试源码分析">
<meta property="og:url" content="http://www.jjmoo.com/blog/android/android-start-activity.html">
<meta property="og:site_name" content="汲墨 | Zohn的博客">
<meta property="og:description" content="1. Activity启动流程-整体概况本文只分析从Launcher冷启动一个App时，启动第一个Activity的过程，暂不考虑其他情况。从Launcher点击应用图标到App第一个Activity启动完毕，期间主要涉及到四个进程：

Launcher
ActivityManagerService
Zygote
App">
<meta property="og:updated_time" content="2017-07-05T17:13:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android7.0 Activity启动流程与App冷启动时间测试源码分析">
<meta name="twitter:description" content="1. Activity启动流程-整体概况本文只分析从Launcher冷启动一个App时，启动第一个Activity的过程，暂不考虑其他情况。从Launcher点击应用图标到App第一个Activity启动完毕，期间主要涉及到四个进程：

Launcher
ActivityManagerService
Zygote
App">
  
    <link rel="alternative" href="/atom.xml" title="汲墨 | Zohn的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://cdn1.jjmoo.com/img/zohn/i150x150" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Zohn</a></h1>
		</hgroup>

		
		<p class="header-subtitle">昨夜西风凋碧树 望尽天涯路</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/alias/" style="font-size: 10px;">alias</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/aosp/" style="font-size: 10px;">aosp</a> <a href="/tags/apache/" style="font-size: 10px;">apache</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/opencv/" style="font-size: 10px;">opencv</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/rm/" style="font-size: 10px;">rm</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/web/" style="font-size: 10px;">web</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Zohn</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://cdn1.jjmoo.com/img/zohn/i150x150" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Zohn</h1>
			</hgroup>
			
			<p class="header-subtitle">昨夜西风凋碧树 望尽天涯路</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-android/android-start-activity" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/android/android-start-activity.html" class="article-date">
  	<time datetime="2017-07-06T02:25:36.000Z" itemprop="datePublished">2017-07-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android7.0 Activity启动流程与App冷启动时间测试源码分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aosp/">aosp</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-Activity启动流程-整体概况"><a href="#1-Activity启动流程-整体概况" class="headerlink" title="1. Activity启动流程-整体概况"></a>1. Activity启动流程-整体概况</h3><p>本文只分析从Launcher冷启动一个App时，启动第一个Activity的过程，暂不考虑其他情况。<br>从Launcher点击应用图标到App第一个Activity启动完毕，期间主要涉及到四个进程：</p>
<ul>
<li>Launcher</li>
<li>ActivityManagerService</li>
<li>Zygote</li>
<li>App</li>
</ul>
<a id="more"></a>
<p>其简要调用过程如下：</p>
<blockquote>
<ol>
<li>[Launcher进程] Launcher中点击应用图标，调用 Activity.startActivity()；</li>
<li>[AMS进程] 创建ActivityRecord，TaskRecord，将所在ActivityStack设为Focused，再调用 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()；</li>
<li>[Launcher进程] 调用 ApplicationThread.schedulePauseActivity()，pause当前activity；</li>
<li>[AMS进程] 再次调用 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()；</li>
<li>[Zygote进程] 调用 Zygote.forkAndSpecialize() 产生新进程；</li>
<li>[App进程] 清理从Zygote继承的信息，创建ActivityThread，并执行其 main() 方法，通知AMS；</li>
<li>[AMS进程] 进行 attach 操作，然后开始对新进程进行调度；</li>
<li>[App进程] 相应AMS的调度，进行Activity的创建和生命周期调用；</li>
</ol>
</blockquote>
<p>尽管这个启动的过程中涉及到了多个进程，但是在时序上基本是串行的，大大降低了分析的难度。</p>
<h3 id="2-Activity冷启动流程-源码分析"><a href="#2-Activity冷启动流程-源码分析" class="headerlink" title="2. Activity冷启动流程-源码分析"></a>2. Activity冷启动流程-源码分析</h3><p>基于Android7.0的源码分析，不同的Launcher可能有不同的实现，一般是在Launcher图标的onClick事件中调用Activity的startActivity()方法，下面从Activity的 startActivity() 开始分析。</p>
<blockquote>
<p>为了方便阅读，约定小节中间的编号代表代码执行所在的进程，如:<br>2.1.x表示在Launcher所在进程中执行;<br>2.2.x表示在ActivityManagerService所在的进程中执行。</p>
</blockquote>
<h4 id="2-1-1-Activity-startActivity"><a href="#2-1-1-Activity-startActivity" class="headerlink" title="2.1.1 Activity.startActivity()"></a>2.1.1 Activity.startActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;  </span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>直接调用了Activity的startActivityForResult方法，默认的requestCode为-1；</li>
</ul>
<h4 id="2-1-2-Activity-startActivityForResult"><a href="#2-1-2-Activity-startActivityForResult" class="headerlink" title="2.1.2 Activity.startActivityForResult()"></a>2.1.2 Activity.startActivityForResult()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">    startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span><br><span class="line">        @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>startActivityForResult(intent, -1) 相当于调用了 startActivityForResult(intent, -1, null);</li>
<li>调用 Instrumentation的 execStartActivity() 启动Activity；</li>
<li>当ar不为null时，调用 mMainThread.sendActivityResult() 发送返回的启动结果，这个方法会调用Activity的  onActivityResult() 方法，默认实现下 execStartActivity() 都是返回null，这里不做进一步的分析；</li>
</ul>
<h4 id="2-1-3-Instrumentation-execStartActivity"><a href="#2-1-3-Instrumentation-execStartActivity" class="headerlink" title="2.1.3 Instrumentation.execStartActivity() "></a>2.1.3 Instrumentation.execStartActivity() <span id="2.1.3"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取ActivityManagerService的本地代理，然后调用其 startActivity() 方法；</li>
<li>ActivityManagerNative.getDefault() 获取的是ActivityManagerService的一个本地代理，是一个ActivityMangerProxy对象，熟悉Android Binder机制以及AIDL原理的话，可以直接跳到<a href="#2.2.3"> <strong>2.2.3</strong> </a>；</li>
</ul>
<h4 id="2-1-4-ActivityManagerNative-getDefault"><a href="#2-1-4-ActivityManagerNative-getDefault" class="headerlink" title="2.1.4 ActivityManagerNative.getDefault()"></a>2.1.4 ActivityManagerNative.getDefault()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager am = asInterface(b);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IActivityManager in =</span><br><span class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getDefault() 返回的是 gDefault.get()，这个使用的是Singleton<t>单例模式，第一次调用 get() 的时候返回 create() 产生的对象，后续调用则直接返回这个对象；</t></li>
<li>ServiceManager.getService(“activity”) 调用ServiceManger的getService()方法获取ActivityMangerService注册的iBinderd对象；</li>
<li>asInterface(b) 将该iBinder对象包装成ActivityManagerProxy代理对象，对外提供跨进程调用服务；对ActivityManagerProxy中的每个方法，ActivityManagerService中都有方法与之对应；</li>
</ul>
<h4 id="2-1-5-ActivityManagerProxy-startActivity"><a href="#2-1-5-ActivityManagerProxy-startActivity" class="headerlink" title="2.1.5 ActivityManagerProxy.startActivity()"></a>2.1.5 ActivityManagerProxy.startActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span><br><span class="line">        String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">    data.writeString(callingPackage);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeString(resolvedType);</span><br><span class="line">    data.writeStrongBinder(resultTo);</span><br><span class="line">    data.writeString(resultWho);</span><br><span class="line">    data.writeInt(requestCode);</span><br><span class="line">    data.writeInt(startFlags);</span><br><span class="line">    <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        data.writeInt(<span class="number">1</span>);</span><br><span class="line">        profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data.writeInt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        data.writeInt(<span class="number">1</span>);</span><br><span class="line">        options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data.writeInt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0) 中，mRemote就是创建ActivityManagerProxy对象时传入的iBinder对象，调用其 transact() 方法发起跨进程调用，由于这个iBinder是ActivityMangerService所提供的，所以最终会调用到ActivityMangerService的 onTransact() 方法；</li>
</ul>
<h4 id="2-2-1-ActivityMangerService-onTransact"><a href="#2-2-1-ActivityMangerService-onTransact" class="headerlink" title="2.2.1 ActivityMangerService.onTransact()"></a>2.2.1 ActivityMangerService.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (code == SYSPROPS_TRANSACTION) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们传入的code不是SYSPROPS_TRANSACTION，所以只需看 super.onTransact(code, data, reply, flags) ，ActivityMangerService继承自ActivityMangerNative，所以我们要看 ActivityMangerNative.onTransact()；</li>
</ul>
<h4 id="2-2-2-ActivityMangerNative-onTransact"><a href="#2-2-2-ActivityMangerNative-onTransact" class="headerlink" title="2.2.2 ActivityMangerNative.onTransact()"></a>2.2.2 ActivityMangerNative.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">        IBinder b = data.readStrongBinder();</span><br><span class="line">        IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">        String callingPackage = data.readString();</span><br><span class="line">        Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">        String resolvedType = data.readString();</span><br><span class="line">        IBinder resultTo = data.readStrongBinder();</span><br><span class="line">        String resultWho = data.readString();</span><br><span class="line">        <span class="keyword">int</span> requestCode = data.readInt();</span><br><span class="line">        <span class="keyword">int</span> startFlags = data.readInt();</span><br><span class="line">        ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></span><br><span class="line">                ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">        Bundle options = data.readInt() != <span class="number">0</span></span><br><span class="line">                ? Bundle.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        reply.writeInt(result);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意此时的ActivityMangerNative和2.1.4中的已经不是在同一个进程了；</li>
<li>这里只是解析参数，然后调用ActivityMangerService的 startActivity() 方法；</li>
</ul>
<h4 id="2-2-3-ActivityMangerService-startActivity"><a href="#2-2-3-ActivityMangerService-startActivity" class="headerlink" title="2.2.3 ActivityMangerService.startActivity() "></a>2.2.3 ActivityMangerService.startActivity() <span id="2.2.3"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-4-ActivityMangerService-startActivityAsUser"><a href="#2-2-4-ActivityMangerService-startActivityAsUser" class="headerlink" title="2.2.4 ActivityMangerService.startActivityAsUser()"></a>2.2.4 ActivityMangerService.startActivityAsUser()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-5-ActivityStarter-startActivityMayWait"><a href="#2-2-5-ActivityStarter-startActivityMayWait" class="headerlink" title="2.2.5 ActivityStarter.startActivityMayWait() "></a>2.2.5 ActivityStarter.startActivityMayWait() <span id="2.2.5"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span><br><span class="line">        String callingPackage, Intent intent, String resolvedType,</span><br><span class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span><br><span class="line">        ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span><br><span class="line">        Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span><br><span class="line">        IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line">    ...</span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line"></span><br><span class="line">    ActivityOptions options = ActivityOptions.fromBundle(bOptions);</span><br><span class="line">    ActivityStackSupervisor.ActivityContainer container =</span><br><span class="line">            (ActivityStackSupervisor.ActivityContainer)iContainer;</span><br><span class="line">    <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                inTask);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类似地，也都是先准备参数，然后进行下一步调用；</li>
<li>ActivityStarter是一个专门管理Activity启动的类，包含了activity启动过程中，所有处理intent、flags、task、stack的逻辑;</li>
<li>ActivityManagService只持有一个ActivityStarter实例，启动Activity的核心代码都位于同步块 synchronized (mService) 中;</li>
</ul>
<h4 id="2-2-6-ActivityStarter-startActivityLocked"><a href="#2-2-6-ActivityStarter-startActivityLocked" class="headerlink" title="2.2.6 ActivityStarter.startActivityLocked()"></a>2.2.6 ActivityStarter.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span><br><span class="line">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span><br><span class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span><br><span class="line">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span><br><span class="line">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span><br><span class="line">        ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span><br><span class="line">        TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">    ...</span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, mSupervisor, container,</span><br><span class="line">            options, sourceRecord);</span><br><span class="line">    <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outActivity[<span class="number">0</span>] = r;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">        err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span>, options, inTask);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个方法最终调用 startActivityUnchecked() 来启动Activity，顾名思义，这个方法主要就是对参数进行check，针对不同的非法参数，返回相应的err；</li>
<li>校验参数后，创建了相应的ActivityRecord，填入outAcitvity[0]，再进入下一步调用；</li>
<li>ActivityRecord记录了待启动的Activity的所有信息，每一个Activity实例都在ActivityManagerService中有一个ActivityRecord与之对应，此时ActivityRecord还没有加入任何的TaskRecord，对应的Activity实例也没有创建；</li>
<li>TaskRecord维护一个Task，其中包含一个Activity列表，是真正意义上的Activity栈;</li>
</ul>
<h4 id="2-2-7-ActivityStarter-startActivityUnchecked"><a href="#2-2-7-ActivityStarter-startActivityUnchecked" class="headerlink" title="2.2.7 ActivityStarter.startActivityUnchecked()"></a>2.2.7 ActivityStarter.startActivityUnchecked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">            voiceInteractor);</span><br><span class="line"></span><br><span class="line">    computeLaunchingTaskFlags();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Should this be considered a new task?</span></span><br><span class="line">    <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">            &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">        newTask = <span class="keyword">true</span>;</span><br><span class="line">        setTaskFromReuseOrCreateNewTask(taskToAffiliate);</span><br><span class="line">    ...</span><br><span class="line">    mTargetStack.startActivityLocked(mStartActivity, newTask, mKeepCurTransition, mOptions);</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mLaunchTaskBehind) &#123;</span><br><span class="line">            ...</span><br><span class="line">            mService.setFocusedActivityLocked(mStartActivity, <span class="string">"startedActivity"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                    mOptions);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>setInitialState() 方法主要是初始化一些状态参数，当设置了FLAG_ACTIVITY_NEW_TASK时，会将mStartActivity.resultTo设置为null；</li>
<li>computeLaunchingTaskFlags() 处理了Activity启动模式相关的参数；</li>
<li>mService.setFocusedActivityLocked() 方法将ActivityManagerService的 mFocusedActivity 设置为待启动的 mStartActivity；</li>
<li>setTaskFromReuseOrCreateNewTask() 见<a href="#2.2.7.1"> <strong>2.2.7.1</strong> </a>；</li>
<li>ActivityStack.startActivityLocked() 见<a href="#2.2.7.2"> <strong>2.2.7.2</strong> </a>；</li>
<li>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() 见<a href="#2.2.8"> <strong>2.2.8</strong> </a>；</li>
</ul>
<h4 id="2-2-7-1-ActivityStarter-setTaskFromReuseOrCreateNewTask"><a href="#2-2-7-1-ActivityStarter-setTaskFromReuseOrCreateNewTask" class="headerlink" title="2.2.7.1 ActivityStarter.setTaskFromReuseOrCreateNewTask() "></a>2.2.7.1 ActivityStarter.setTaskFromReuseOrCreateNewTask() <span id="2.2.7.1"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setTaskFromReuseOrCreateNewTask</span><span class="params">(TaskRecord taskToAffiliate)</span> </span>&#123;</span><br><span class="line">    mTargetStack = computeStackFocus(mStartActivity, <span class="keyword">true</span>, mLaunchBounds, mLaunchFlags,</span><br><span class="line">            mOptions);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mReuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = mTargetStack.createTaskRecord(</span><br><span class="line">                mSupervisor.getNextTaskIdForUserLocked(mStartActivity.userId),</span><br><span class="line">                mNewTaskInfo != <span class="keyword">null</span> ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                mNewTaskIntent != <span class="keyword">null</span> ? mNewTaskIntent : mIntent,</span><br><span class="line">                mVoiceSession, mVoiceInteractor, !mLaunchTaskBehind <span class="comment">/* toTop */</span>);</span><br><span class="line">        mStartActivity.setTask(task, taskToAffiliate);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mStartActivity.setTask(mReuseTask, taskToAffiliate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 computeStackFocus() 方法获得一个将用来管理mStartActivity的ActivityStack；</li>
<li>调用ActivityStack的 createTaskRecord() 方法创建TaskRecord；</li>
<li>调用ActivityRecord的 setTask() 方法设置mStartActivity应该添加到的task为刚创建的TaskRecord；</li>
</ul>
<h4 id="2-2-7-2-ActivityStack-startActivityLocked"><a href="#2-2-7-2-ActivityStack-startActivityLocked" class="headerlink" title="2.2.7.2 ActivityStack.startActivityLocked() "></a>2.2.7.2 ActivityStack.startActivityLocked() <span id="2.2.7.2"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition,</span><br><span class="line">        ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    task.addActivityToTop(r);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>将mStartActivity这个ActivityRecord实例加入到前面创建的TaskRecord的栈顶；</li>
<li>ActivityStack、TaskRecord、ActivityRecord全部到位，ActivityManagerService的 mFocusedActivity也被设置成了当前待启动的ActivityRecord全部到位，此时Activity管理相关的准备工作已经完成；</li>
</ul>
<h4 id="2-2-8-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#2-2-8-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="2.2.8 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() "></a>2.2.8 ActivityStackSupervisor.resumeFocusedStackTopActivityLocked() <span id="2.2.8"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span><br><span class="line">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>很明显，targetStack不为空，且isFocusedStack(targetStack)为true；</li>
</ul>
<h4 id="2-2-9-ActivityStack-resumeTopActivityUncheckedLocked"><a href="#2-2-9-ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="2.2.9 ActivityStack.resumeTopActivityUncheckedLocked()"></a>2.2.9 ActivityStack.resumeTopActivityUncheckedLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-10-ActivityStack-resumeTopActivityInnerLocked"><a href="#2-2-10-ActivityStack-resumeTopActivityInnerLocked" class="headerlink" title="2.2.10 ActivityStack.resumeTopActivityInnerLocked() "></a>2.2.10 ActivityStack.resumeTopActivityInnerLocked() <span id="2.2.10"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (pausing) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>topRunningActivityLocked() 获取之前最后一个加入到栈顶的不是处于结束状态的ActivityRecord，此时获取到的就是我们之前加入的mStartActivity，在这里就是prev；</li>
<li>由于当前Launcher还处于活跃的状态，调用ActivityStackSupervisor的 pauseBackStacks() 方法会返回true，从而直接return true退出，整个 startActivity() 方法的调用过程到这里就已经结束了；</li>
<li><strong>注意此时我们的目标Activity还没有被实例化，</strong>只是其相应的ActivityRecord已经准备好了而已。</li>
</ul>
<h4 id="2-2-11-ActivityStackSupervisor-pauseBackStacks"><a href="#2-2-11-ActivityStackSupervisor-pauseBackStacks" class="headerlink" title="2.2.11 ActivityStackSupervisor.pauseBackStacks()"></a>2.2.11 ActivityStackSupervisor.pauseBackStacks()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">pauseBackStacks</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> someActivityPaused = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack) &amp;&amp; stack.mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">"pauseBackStacks: stack="</span> + stack +</span><br><span class="line">                        <span class="string">" mResumedActivity="</span> + stack.mResumedActivity);</span><br><span class="line">                someActivityPaused |= stack.startPausingLocked(userLeaving, <span class="keyword">false</span>, resuming,</span><br><span class="line">                        dontWait);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> someActivityPaused;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对每个ActivityStack执行其 startPausingLocked() 方法，只要有一个返回了true，则整个方法会返回true；</li>
</ul>
<h4 id="2-2-12-ActivityStack-startPausingLocked"><a href="#2-2-12-ActivityStack-startPausingLocked" class="headerlink" title="2.2.12 ActivityStack.startPausingLocked()"></a>2.2.12 ActivityStack.startPausingLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping, <span class="keyword">boolean</span> resuming,</span><br><span class="line">        <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ActivityRecord prev = mResumedActivity;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>prev.app是一个ProcessRecord的对象，持有该ActivityRecord代表的Activity其所在的进程的所有信息；</li>
<li>prev.app.thread是对应Activity所在的进程的ApplicationThread的代理对象ApplicationThreadProxy；</li>
</ul>
<h4 id="2-2-13-ApplicationThreadProxy-schedulePauseActivity"><a href="#2-2-13-ApplicationThreadProxy-schedulePauseActivity" class="headerlink" title="2.2.13 ApplicationThreadProxy.schedulePauseActivity()"></a>2.2.13 ApplicationThreadProxy.schedulePauseActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span><br><span class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    data.writeInt(finished ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    data.writeInt(userLeaving ? <span class="number">1</span> :<span class="number">0</span>);</span><br><span class="line">    data.writeInt(configChanges);</span><br><span class="line">    data.writeInt(dontReport ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    mRemote.transact(SCHEDULE_PAUSE_ACTIVITY_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类似于<a href="#2.1.3"> <strong>2.1.3</strong> </a>中，通过获取ActivityManagerService的代理对象ActivityManagerProxy来执行操作，ActivityManagerService也可以通过ApplicationThread的代理对象，对应用所在进程发起远程调用；</li>
</ul>
<h4 id="2-1-7-ApplicationThreadNative-onTransact"><a href="#2-1-7-ApplicationThreadNative-onTransact" class="headerlink" title="2.1.7 ApplicationThreadNative.onTransact()"></a>2.1.7 ApplicationThreadNative.onTransact()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> SCHEDULE_PAUSE_ACTIVITY_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">        IBinder b = data.readStrongBinder();</span><br><span class="line">        <span class="keyword">boolean</span> finished = data.readInt() != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> userLeaving = data.readInt() != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> configChanges = data.readInt();</span><br><span class="line">        <span class="keyword">boolean</span> dontReport = data.readInt() != <span class="number">0</span>;</span><br><span class="line">        schedulePauseActivity(b, finished, userLeaving, configChanges, dontReport);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-8-ActivityThread-ApplicationThread-schedulePauseActivity"><a href="#2-1-8-ActivityThread-ApplicationThread-schedulePauseActivity" class="headerlink" title="2.1.8 ActivityThread$ApplicationThread.schedulePauseActivity() "></a>2.1.8 ActivityThread$ApplicationThread.schedulePauseActivity() <span id="2.1.8"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span><br><span class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"pauseActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">            + <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">    sendMessage(</span><br><span class="line">            finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">            token,</span><br><span class="line">            (userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">            configChanges,</span><br><span class="line">            seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>sendMessage() 方法会调用内部类ActivityThread$H的 sendMessage() 方法，通过Handler机制，最终在其 handleMessage() 方法中执行相关操作；</li>
<li>发送完Message以后，远程调用就已经完成了，handleMessage() 的操作将和ActivityManagerService的后续操作并行执行；</li>
</ul>
<h4 id="2-1-9-ActivityThread-H-handleMessage"><a href="#2-1-9-ActivityThread-H-handleMessage" class="headerlink" title="2.1.9 ActivityThread$H.handleMessage()"></a>2.1.9 ActivityThread$H.handleMessage()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</span><br><span class="line">            ...</span><br><span class="line">            handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</span><br><span class="line">                    (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                    (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PAUSE_ACTIVITY_FINISHING: &#123;</span><br><span class="line">            ...</span><br><span class="line">            handlePauseActivity((IBinder) args.arg1, <span class="keyword">true</span>, (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>,</span><br><span class="line">                    args.argi2, (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-10-ActivityThread-H-handlePauseActivity"><a href="#2-1-10-ActivityThread-H-handlePauseActivity" class="headerlink" title="2.1.10 ActivityThread$H.handlePauseActivity()"></a>2.1.10 ActivityThread$H.handlePauseActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span><br><span class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>performPauseActivity() 执行当前Activity的pause操作，期间会调用Activity的 onPause() 方法；</li>
<li>pause完毕后，调用ActivityManagerProxy的 activityPaused(token) 方法通知ActivityManagerService当前Activity已经pause完毕，这里不再分析远程调用过程；</li>
</ul>
<h4 id="2-2-14-ActivityManagerService-activityPaused"><a href="#2-2-14-ActivityManagerService-activityPaused" class="headerlink" title="2.2.14 ActivityManagerService.activityPaused()"></a>2.2.14 ActivityManagerService.activityPaused()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stack.activityPausedLocked(token, <span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-15-ActivityStack-activityPausedLocked"><a href="#2-2-15-ActivityStack-activityPausedLocked" class="headerlink" title="2.2.15 ActivityStack.activityPausedLocked()"></a>2.2.15 ActivityStack.activityPausedLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPausedLocked</span><span class="params">(IBinder token, <span class="keyword">boolean</span> timeout)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">            completePauseLocked(<span class="keyword">true</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-16-ActivityStack-completePauseLocked"><a href="#2-2-16-ActivityStack-completePauseLocked" class="headerlink" title="2.2.16 ActivityStack.completePauseLocked()"></a>2.2.16 ActivityStack.completePauseLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">completePauseLocked</span><span class="params">(<span class="keyword">boolean</span> resumeNext)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (resumeNext) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityStack topStack = mStackSupervisor.getFocusedStack();</span><br><span class="line">        <span class="keyword">if</span> (!mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line">            mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这就又回到了<a href="#2.2.8"> <strong>2.2.8</strong> </a>中的调用；</li>
<li>这一次在 <a href="#2.2.10"> <strong>2.2.10</strong> </a>中，由于当前所有的Activity已经pause过了，所以 ActivityStackSupervisor.pauseBackStacks() 方法将返回false；</li>
<li>此时的next还是带启动Activity对应的ActivityRecord，由于此时新的进程还没有建立，所以next.app为null值；</li>
</ul>
<h4 id="2-2-17-ActivityStackSupervisor-startSpecificActivityLocked"><a href="#2-2-17-ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="2.2.17 ActivityStackSupervisor.startSpecificActivityLocked() "></a>2.2.17 ActivityStackSupervisor.startSpecificActivityLocked() <span id="2.2.17"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span><br><span class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Is this activity's application already running?</span></span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">    </span><br><span class="line">    r.task.stack.setLaunchTime(r);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>很明显app为null，直接调用ActivityManagerService的 startProcessLocked() 方法；</li>
</ul>
<h4 id="2-2-18-ActivityManagerService-startProcessLocked"><a href="#2-2-18-ActivityManagerService-startProcessLocked" class="headerlink" title="2.2.18 ActivityManagerService.startProcessLocked()"></a>2.2.18 ActivityManagerService.startProcessLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span><br><span class="line">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</span><br><span class="line">        <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</span><br><span class="line">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    startProcessLocked(</span><br><span class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName,</span><br><span class="line">        ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span><br><span class="line">        String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting,</span><br><span class="line">        <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</span><br><span class="line">            hostingName, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>, keepIfLarge,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span><br><span class="line">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// Start the process.  It will either succeed and return a result containing</span></span><br><span class="line">        <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></span><br><span class="line">        ...</span><br><span class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, entryPointArgs);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-19-Process-start"><a href="#2-2-19-Process-start" class="headerlink" title="2.2.19 Process.start()"></a>2.2.19 Process.start()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span><br><span class="line">                              <span class="keyword">final</span> String niceName,</span><br><span class="line">                              <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span><br><span class="line">                              <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span><br><span class="line">                              <span class="keyword">int</span> targetSdkVersion,</span><br><span class="line">                              String seInfo,</span><br><span class="line">                              String abi,</span><br><span class="line">                              String instructionSet,</span><br><span class="line">                              String appDataDir,</span><br><span class="line">                              String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                debugFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, zygoteArgs);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-20-Process-startViaZygote"><a href="#2-2-20-Process-startViaZygote" class="headerlink" title="2.2.20 Process.startViaZygote()"></a>2.2.20 Process.startViaZygote()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span><br><span class="line">                              <span class="keyword">final</span> String niceName,</span><br><span class="line">                              <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span><br><span class="line">                              <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span><br><span class="line">                              <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span><br><span class="line">                              <span class="keyword">int</span> targetSdkVersion,</span><br><span class="line">                              String seInfo,</span><br><span class="line">                              String abi,</span><br><span class="line">                              String instructionSet,</span><br><span class="line">                              String appDataDir,</span><br><span class="line">                              String[] extraArgs)</span></span><br><span class="line">                              <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(Process.class) &#123;</span><br><span class="line">        ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>准备各项参数，然后继续调用;</li>
</ul>
<h4 id="2-2-20-Process-zygoteSendArgsAndGetResult"><a href="#2-2-20-Process-zygoteSendArgsAndGetResult" class="headerlink" title="2.2.20 Process.zygoteSendArgsAndGetResult()"></a>2.2.20 Process.zygoteSendArgsAndGetResult()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span><br><span class="line">        ZygoteState zygoteState, ArrayList&lt;String&gt; args)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Throw early if any of the arguments are malformed. This means we can</span></span><br><span class="line">        <span class="comment">// avoid writing a partial response to the zygote.</span></span><br><span class="line">        <span class="keyword">int</span> sz = args.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.get(i).indexOf(<span class="string">'\n'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"embedded newlines not allowed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> BufferedWriter writer = zygoteState.writer;</span><br><span class="line">        <span class="keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;</span><br><span class="line">        </span><br><span class="line">        writer.write(Integer.toString(args.size()));</span><br><span class="line">        writer.newLine();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            String arg = args.get(i);</span><br><span class="line">            writer.write(arg);</span><br><span class="line">            writer.newLine();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        writer.flush();</span><br><span class="line">        ...</span><br><span class="line">        result.pid = inputStream.readInt();</span><br><span class="line">        result.usingWrapper = inputStream.readBoolean();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过socket通信向zygote发送启动参数，并获取结果；</li>
</ul>
<h4 id="2-3-1-ZynoteInit-main"><a href="#2-3-1-ZynoteInit-main" class="headerlink" title="2.3.1 ZynoteInit.main() "></a>2.3.1 ZynoteInit.main() <span id="2.3.1"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        registerZygoteSocket(socketName);</span><br><span class="line">        ...</span><br><span class="line">        Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</span><br><span class="line">        runSelectLoop(abiList);</span><br><span class="line">        ...</span><br><span class="line">        closeServerSocket();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</span><br><span class="line">        closeServerSocket();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从ZynoteInit的 main() 方法开始看起；</li>
<li>先是注册一个Socket监听，然后运行主循环；</li>
<li>Zynote进程本身会一直在主循环里面执行，不断的读取socket消息并进行fork操作；</li>
<li>fork出来的新进程一定会抛出MethodAndArgsCaller这个“异常”，被 main() 方法捕获，并调用其run方法；</li>
<li>通过抛出MethodAndArgsCaller，在代码流程上，可以从很深层次的代码中，直接跳到最外面异常捕获代码；</li>
<li>MethodAndArgsCaller.run() 在正常情况下，会执行新产生的进程的初始化类的 main() 方法；</li>
</ul>
<h4 id="2-3-2-ZynoteInit-runSelectLoop"><a href="#2-3-2-ZynoteInit-runSelectLoop" class="headerlink" title="2.3.2 ZynoteInit.runSelectLoop()"></a>2.3.2 ZynoteInit.runSelectLoop()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</span><br><span class="line">                <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                    peers.remove(i);</span><br><span class="line">                    fds.remove(i);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ZygoteConnection <span class="title">acceptCommandPeer</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZygoteConnection(sServerSocket.accept(), abiList);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>监听socket通信，读取参数，创建ZygoteConnection对象，然后调用其 runOnce() 方法；</li>
</ul>
<h4 id="2-3-3-ZygoteConnection-runOnce"><a href="#2-3-3-ZygoteConnection-runOnce" class="headerlink" title="2.3.3 ZygoteConnection.runOnce()"></a>2.3.3 ZygoteConnection.runOnce()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">                parsedArgs.appDataDir);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用 Zygote.forkAndSpecialize() 复制新的进程；</li>
<li>pid为0，表示是子进程，调用 handleChildProc()，抛出MethodAndArgsCaller；</li>
<li>pid不为0时，表示当前进程是父进程，调用 handleParentProc()，处理善后工作，继续监听Socket端口；</li>
</ul>
<h4 id="2-4-1-ZygoteConnection-handleChildProc"><a href="#2-4-1-ZygoteConnection-handleChildProc" class="headerlink" title="2.4.1 ZygoteConnection.handleChildProc()"></a>2.4.1 ZygoteConnection.handleChildProc()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span><br><span class="line">        FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    closeSocket();</span><br><span class="line">    ZygoteInit.closeServerSocket();</span><br><span class="line">    ...</span><br><span class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭从父进程fork过来的Socket连接和Socket端口监听；</li>
<li>注意，这时代码所运行的进程已经是新的进程了，新的Activity将在这个进程中启动；</li>
</ul>
<h4 id="2-4-2-RuntimeInit-zygoteInit"><a href="#2-4-2-RuntimeInit-zygoteInit" class="headerlink" title="2.4.2 RuntimeInit.zygoteInit()"></a>2.4.2 RuntimeInit.zygoteInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    commonInit();</span><br><span class="line">    nativeZygoteInit();</span><br><span class="line">    applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-3-RuntimeInit-applicationInit"><a href="#2-4-3-RuntimeInit-applicationInit" class="headerlink" title="2.4.3 RuntimeInit.applicationInit()"></a>2.4.3 RuntimeInit.applicationInit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    invokeStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-4-RuntimeInit-invokeStaticMain"><a href="#2-4-4-RuntimeInit-invokeStaticMain" class="headerlink" title="2.4.4 RuntimeInit.invokeStaticMain()"></a>2.4.4 RuntimeInit.invokeStaticMain()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">    ...</span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过反射的方式创建了Class和Method对象，在这里其实就是ActivityThread的 main() 方法；</li>
<li>将Method对象包装成ZygoteInit.MethodAndArgsCaller抛出去，将会在<a href="#2.3.1"> <strong>2.3.1</strong> </a>的 caller.run() 执行这个Method；</li>
</ul>
<h4 id="2-4-5-ActivityThread-main"><a href="#2-4-5-ActivityThread-main" class="headerlink" title="2.4.5 ActivityThread.main()"></a>2.4.5 ActivityThread.main()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    </span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line">    Looper.loop();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建新进程的ActivityThread；</li>
<li>调用 ActivityThread.attach() 通知ActivityManagerService，false表示非系统进程；</li>
<li>调用loop()，新进程的主线程准备就绪;</li>
</ul>
<h4 id="2-4-6-ActivityThread-attach"><a href="#2-4-6-ActivityThread-attach" class="headerlink" title="2.4.6 ActivityThread.attach()"></a>2.4.6 ActivityThread.attach()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用ActivityManagerService的代理对象ActivityManagerProxy的 attachApplication() 方法进行远程调用；</li>
</ul>
<h4 id="2-2-21-ActivityManagerService-attachApplication"><a href="#2-2-21-ActivityManagerService-attachApplication" class="headerlink" title="2.2.21 ActivityManagerService.attachApplication()"></a>2.2.21 ActivityManagerService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-22-ActivityManagerService-attachApplicationLocked"><a href="#2-2-22-ActivityManagerService-attachApplicationLocked" class="headerlink" title="2.2.22 ActivityManagerService.attachApplicationLocked() "></a>2.2.22 ActivityManagerService.attachApplicationLocked() <span id="2.2.22"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span><br><span class="line">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode,</span><br><span class="line">                mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</span><br><span class="line">                getCommonServicesLocked(app.isolated),</span><br><span class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>thread是新进程中ActivityThread$ApplicationThread的一个代理对象，其bindApplication() 是一个远程调用；</li>
<li>调用ActivitySupervisor的 attachApplicationLocked() 来启动新的Acitivity；</li>
</ul>
<h4 id="2-4-7-ActivityThread-ApplicationThread-bindApplication"><a href="#2-4-7-ActivityThread-ApplicationThread-bindApplication" class="headerlink" title="2.4.7 ActivityThread$ApplicationThread.bindApplication()"></a>2.4.7 ActivityThread$ApplicationThread.bindApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span><br><span class="line">        List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span><br><span class="line">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span><br><span class="line">        IInstrumentationWatcher instrumentationWatcher,</span><br><span class="line">        IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</span><br><span class="line">        <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</span><br><span class="line">        <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</span><br><span class="line">        CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    AppBindData data = <span class="keyword">new</span> AppBindData();</span><br><span class="line">    ...</span><br><span class="line">    sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>读取调用参数，打包成AppBindData对象，通过Handler机制执行，类似<a href="#2.1.8"> <strong>2.1.8</strong> </a></li>
</ul>
<h4 id="2-4-8-ActivityThread-H-handleMessenge"><a href="#2-4-8-ActivityThread-H-handleMessenge" class="headerlink" title="2.4.8 ActivityThread$H.handleMessenge()"></a>2.4.8 ActivityThread$H.handleMessenge()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line">            ...</span><br><span class="line">            AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">            handleBindApplication(data);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-9-ActivityThread-handleBindApplication"><a href="#2-4-9-ActivityThread-handleBindApplication" class="headerlink" title="2.4.9 ActivityThread.handleBindApplication()"></a>2.4.9 ActivityThread.handleBindApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mBoundApplication = data;</span><br><span class="line">    mConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    mCompatConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> InstrumentationInfo ii;</span><br><span class="line">    <span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ii = <span class="keyword">new</span> ApplicationPackageManager(<span class="keyword">null</span>, getPackageManager())</span><br><span class="line">                    .getInstrumentationInfo(data.instrumentationName, <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (ii != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> ComponentName component = <span class="keyword">new</span> ComponentName(ii.packageName, ii.name);</span><br><span class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, component,</span><br><span class="line">                data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">        mInitialApplication = app;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ActivityThread.handleBindApplication() 方法所做的事情很多，这里不作分析；</li>
<li>mInstrumentation.callApplicationOnCreate() 会调用app的 onCreate() 方法；</li>
<li>app.onCreate() 方法实际上调用的就是应用声明的Application对象生命周期中的onCreate() 方法；</li>
</ul>
<h4 id="2-2-23-ActivityStackSupervisor-attachApplicationLocked"><a href="#2-2-23-ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="2.2.23 ActivityStackSupervisor.attachApplicationLocked()"></a>2.2.23 ActivityStackSupervisor.attachApplicationLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            ...</span><br><span class="line">            ActivityRecord hr = stack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里继续回到<a href="#2.2.22"> <strong>2.2.22</strong> </a> mStackSupervisor.attachApplicationLocked()；</li>
<li>遍历mActivityDisplays中所有的ActivityStack，找到处于栈顶等待运行，并且其uid与app的uid一致的ActivityRecord，实际上就是待启动的Activity所对应的ActivityRecord；</li>
</ul>
<h4 id="2-2-24-ActivityStackSupervisor-realStartActivityLocked"><a href="#2-2-24-ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="2.2.24 ActivityStackSupervisor.realStartActivityLocked()"></a>2.2.24 ActivityStackSupervisor.realStartActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span><br><span class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类似于<a href="2.2.22"> <strong>2.2.22</strong> </a>，这里也是一个远程调用，在远端又会通过Hanler机制进行调用，最终执行的是ActivityThread的 handleLaunchActivity() 方法；</li>
</ul>
<h4 id="2-4-10-ActivityThread-handleLaunchActivity"><a href="#2-4-10-ActivityThread-handleLaunchActivity" class="headerlink" title="2.4.10 ActivityThread.handleLaunchActivity()"></a>2.4.10 ActivityThread.handleLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    ...</span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    </span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化配置和窗口管理器；</li>
</ul>
<h4 id="2-4-11-1-ActivityThread-performLaunchActivity"><a href="#2-4-11-1-ActivityThread-performLaunchActivity" class="headerlink" title="2.4.11(1) ActivityThread.performLaunchActivity()"></a>2.4.11(1) ActivityThread.performLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                                r.persistentState);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class="line">                            r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Instrumentation.newActivity() 通过反射的方式创建Activity实例；</li>
<li>Instrumentation.callActivityOnCreate() 中会调用 Activity.performCreate()，其中会调用Activity生命周期中的 onCreate() 方法；</li>
<li>Activity.performStart() 中会调用 Instrumentation.callActivityOnStart()，其中会调用Activity生命周期中的 onStart() 方法；</li>
<li>Instrumentation.callActivityOnRestoreInstanceState() 中会调用 Activity.performRestoreInstanceState()，其中会调用Activity生命周期中的 onRestoreInstanceState() 方法；</li>
<li>Instrumentation.callActivityOnPostCreate() 会调用Activity生命周期中的 onPostCreate() 方法；</li>
</ul>
<h4 id="2-4-11-2-ActivityThread-handleResumeActivity"><a href="#2-4-11-2-ActivityThread-handleResumeActivity" class="headerlink" title="2.4.11(2) ActivityThread.handleResumeActivity() "></a>2.4.11(2) ActivityThread.handleResumeActivity() <span id="2.4.11.2"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span><br><span class="line">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (reallyResume) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ActivityThread.performResumeActivity() 会调用 Activity.performResume()，其中会调用到Activity生命周期中的 onRestart()(如果mStopped为true)、onResume()、onPostResume();</li>
<li>r.window.getDecorView() 返回一个DecorView，DecorView继承了FragmentLayout，在 onCreate() 方法中第一次调用 setContentView() 时初始化，是整个View的根节点；</li>
<li>a.getWindowManager() 获取的是一个实现了ViewManager接口的WindowManagerImpl对象，调用其 addView() 方法，进行整个View的绘制；</li>
<li>最后调用ActivityManagerService的代理对象ActivityManagerProxy的 activityResumed() 通知ActivityManagerService，该Activity已经启动完毕，并且成功resume了；</li>
</ul>
<h3 id="3-Activity启动时间测试-测试方法"><a href="#3-Activity启动时间测试-测试方法" class="headerlink" title="3. Activity启动时间测试-测试方法"></a>3. Activity启动时间测试-测试方法</h3><p>ActivityManagerService提供了测试Activity启动时间的方法 startActivityAndWait()，调用该方法启动Activity会返回一个IActivityManager$WaitResult对象，其中就包含了Activity的启动时间；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">intent.setAction(Intent.ACTION_MAIN);</span><br><span class="line">intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">        | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">intent.setClassName(<span class="string">"com.android.dialer"</span>,</span><br><span class="line">        <span class="string">"com.android.dialer.activity.ContactsToDialerActivity"</span>);</span><br><span class="line"></span><br><span class="line">IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">IActivityManager.WaitResult result = am.startActivityAndWait(</span><br><span class="line">        <span class="keyword">null</span>, <span class="keyword">null</span>, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>,</span><br><span class="line">        intent.getFlags(), <span class="keyword">null</span>, <span class="keyword">null</span>, -<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Log.e(TAG, <span class="string">"Dialer Launch Time: "</span> + result.thisTime);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>准备好启动Activity的Intent</li>
<li>获取ActivityManagerService的代理对象</li>
<li>调用其 startActivityAndWait() 方法，可能抛出RemoteException；</li>
</ul>
<ol>
<li>时间起点为：<a href="#2.2.17"> <strong>2.2.17</strong> </a>中的 ActivityStackSupervisor.startSpecificActivityLocked()：r.task.stack.setLaunchTime(r)；</li>
<li>时间终点为：<a href="#2.4.11.2"> <strong>2.4.11(2)</strong> </a>中的 ActivityThread.handleResumeActivity()：wm.addView()；</li>
</ol>
<h3 id="4-Activity启动时间测试-源码分析"><a href="#4-Activity启动时间测试-源码分析" class="headerlink" title="4. Activity启动时间测试-源码分析"></a>4. Activity启动时间测试-源码分析</h3><h4 id="4-1-ActivityManagerService-startActivityAndWait"><a href="#4-1-ActivityManagerService-startActivityAndWait" class="headerlink" title="4.1 ActivityManagerService.startActivityAndWait()"></a>4.1 ActivityManagerService.startActivityAndWait()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> WaitResult <span class="title">startActivityAndWait</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivityAndWait"</span>);</span><br><span class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivityAndWait"</span>, <span class="keyword">null</span>);</span><br><span class="line">    WaitResult res = <span class="keyword">new</span> WaitResult();</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent, resolvedType,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags, profilerInfo, res, <span class="keyword">null</span>,</span><br><span class="line">            bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实例化一个空的WaitResult对象，作为输出参数传入 ActivityStarter.startActivityMayWait()； </li>
</ul>
<h4 id="4-2-ActivityManagerService-startActivityAndWait"><a href="#4-2-ActivityManagerService-startActivityAndWait" class="headerlink" title="4.2 ActivityManagerService.startActivityAndWait()"></a>4.2 ActivityManagerService.startActivityAndWait()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span><br><span class="line">        String callingPackage, Intent intent, String resolvedType,</span><br><span class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span><br><span class="line">        ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span><br><span class="line">        Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span><br><span class="line">        IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                inTask);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outResult.result = res;</span><br><span class="line">            <span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">                mSupervisor.mWaitingActivityLaunched.add(outResult);</span><br><span class="line">                do &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mService.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">while</span> (outResult.result != START_TASK_TO_FRONT</span><br><span class="line">                        &amp;&amp; !outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (outResult.result == START_TASK_TO_FRONT) &#123;</span><br><span class="line">                    res = START_TASK_TO_FRONT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (res == START_TASK_TO_FRONT) &#123;</span><br><span class="line">                ActivityRecord r = stack.topRunningActivityLocked();</span><br><span class="line">                <span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</span><br><span class="line">                    outResult.timeout = <span class="keyword">false</span>;</span><br><span class="line">                    outResult.who = <span class="keyword">new</span> ComponentName(r.info.packageName, r.info.name);</span><br><span class="line">                    outResult.totalTime = <span class="number">0</span>;</span><br><span class="line">                    outResult.thisTime = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outResult.thisTime = SystemClock.uptimeMillis();</span><br><span class="line">                    mSupervisor.mWaitingActivityVisible.add(outResult);</span><br><span class="line">                    do &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mService.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个方法在<a href="#2.2.5"> <strong>2.2.5</strong> </a>分析过，这里我们只关注 outResult != null 的部分；</li>
<li>这里的outResult就是我们前面传入的 IActivityManager$WaitResult 对象，显然不为null；</li>
<li>mSupervisor.mWaitingActivityLaunched是一个ArrayList<iactivitymanager.waitresult>类型的列表，保存着等待计算启动时间的WaitResult对象；</iactivitymanager.waitresult></li>
<li>接下来就是调用 mService.wait() 等待应用启动完毕，当 mService.notify() 或者 mService.notifyAll() 被调用时，判断循环条件，如果不满足条件则退出循环；</li>
<li>退出循环的条件有3个，outResult.result == START_TASK_TO_FRONT、outResult.timeout 或者 outResult.who ！= null，很明显，在冷启动的环境下，正常流程的退出条件应为 outResult.who 不为空；</li>
</ul>
<h4 id="4-3-ActivityStackSupervisor-reportActivityLaunchedLocked"><a href="#4-3-ActivityStackSupervisor-reportActivityLaunchedLocked" class="headerlink" title="4.3 ActivityStackSupervisor.reportActivityLaunchedLocked()"></a>4.3 ActivityStackSupervisor.reportActivityLaunchedLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportActivityLaunchedLocked</span><span class="params">(<span class="keyword">boolean</span> timeout, ActivityRecord r,</span><br><span class="line">        <span class="keyword">long</span> thisTime, <span class="keyword">long</span> totalTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mWaitingActivityLaunched.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        WaitResult w = mWaitingActivityLaunched.remove(i);</span><br><span class="line">        <span class="keyword">if</span> (w.who == <span class="keyword">null</span>) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">            w.timeout = timeout;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                w.who = <span class="keyword">new</span> ComponentName(r.info.packageName, r.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            w.thisTime = thisTime;</span><br><span class="line">            w.totalTime = totalTime;</span><br><span class="line">            <span class="comment">// Do not modify w.result.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mService.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在源码里面搜索”mService.notify”，逐一排除可确定，ActivityStackSupervisor.reportActivityLaunchedLocked() 就是计算启动时间的终点；</li>
<li>读出mWaitingActivityLaunched中的WaitResult，然后对其各个属性赋值，数据来自函数入参；</li>
</ul>
<h4 id="4-4-ActivityRecord-reportLaunchTimeLocked"><a href="#4-4-ActivityRecord-reportLaunchTimeLocked" class="headerlink" title="4.4 ActivityRecord.reportLaunchTimeLocked()"></a>4.4 ActivityRecord.reportLaunchTimeLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportLaunchTimeLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> curTime)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> thisTime = curTime - displayStartTime;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> totalTime = stack.mLaunchStartTime != <span class="number">0</span></span><br><span class="line">            ? (curTime - stack.mLaunchStartTime) : thisTime;</span><br><span class="line">    ...</span><br><span class="line">    mStackSupervisor.reportActivityLaunchedLocked(<span class="keyword">false</span>, <span class="keyword">this</span>, thisTime, totalTime);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>thisTime = curTime - displayStartTime，curTime是当前的时间，displayStartTime是开始启动这个应用的时间；</li>
<li>只要找出displayStartTime和curTime的赋值点，就确定了应用冷启动时间计算的起点和终点；</li>
</ul>
<h4 id="4-5-ActivityStack-setLaunchTime"><a href="#4-5-ActivityStack-setLaunchTime" class="headerlink" title="4.5 ActivityStack.setLaunchTime()"></a>4.5 ActivityStack.setLaunchTime()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setLaunchTime</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r.displayStartTime == <span class="number">0</span>) &#123;</span><br><span class="line">        r.fullyDrawnStartTime = r.displayStartTime = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (mLaunchStartTime == <span class="number">0</span>) &#123;</span><br><span class="line">            startLaunchTraces(r.packageName);</span><br><span class="line">            mLaunchStartTime = mFullyDrawnStartTime = r.displayStartTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLaunchStartTime == <span class="number">0</span>) &#123;</span><br><span class="line">        startLaunchTraces(r.packageName);</span><br><span class="line">        mLaunchStartTime = mFullyDrawnStartTime = SystemClock.uptimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>r.fullyDrawnStartTime = r.displayStartTime = SystemClock.uptimeMillis() 将当前时间赋值给displayStartTime，作为<strong>计时的起点</strong>；</li>
<li>其在整个启动流程中的调用位置在<a href="#2.2.17"> <strong>2.2.17</strong> </a>的 ActivityStackSupervisor.startSpecificActivityLocked() 中；</li>
</ul>
<h4 id="4-6-ActivityRecord-windowsDrawnLocked"><a href="#4-6-ActivityRecord-windowsDrawnLocked" class="headerlink" title="4.6 ActivityRecord.windowsDrawnLocked() "></a>4.6 ActivityRecord.windowsDrawnLocked() <span id="4.6"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">windowsDrawnLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mStackSupervisor.mActivityMetricsLogger.notifyWindowsDrawn();</span><br><span class="line">    <span class="keyword">if</span> (displayStartTime != <span class="number">0</span>) &#123;</span><br><span class="line">        reportLaunchTimeLocked(SystemClock.uptimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    mStackSupervisor.sendWaitingVisibleReportLocked(<span class="keyword">this</span>);</span><br><span class="line">    startTime = <span class="number">0</span>;</span><br><span class="line">    finishLaunchTickingLocked();</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">        task.hasBeenVisible = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在调用 reportLaunchTimeLocked(SystemClock.uptimeMillis()) 时，将当前时间传入curTime，作为<strong>计时的终点</strong>；</li>
<li>接下来关注 ActivityRecord.windowsDrawnLocked() 的调用位置；</li>
</ul>
<h4 id="4-7-WindowManagerService-H-handleMessage"><a href="#4-7-WindowManagerService-H-handleMessage" class="headerlink" title="4.7 WindowManagerService$H.handleMessage()"></a>4.7 WindowManagerService$H.handleMessage()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> REPORT_APPLICATION_TOKEN_DRAWN: &#123;</span><br><span class="line">            <span class="keyword">final</span> AppWindowToken wtoken = (AppWindowToken)msg.obj;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                wtoken.appToken.windowsDrawn();</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ActivityRecord$Token.windowsDrawn() 中会调用 ActivityRecord.windowsDrawnLocked()；</li>
</ul>
<h4 id="4-8-WindowManagerService-relayoutWindow"><a href="#4-8-WindowManagerService-relayoutWindow" class="headerlink" title="4.8 WindowManagerService.relayoutWindow() "></a>4.8 WindowManagerService.relayoutWindow() <span id="4.8"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span><br><span class="line">        WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth,</span><br><span class="line">        <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span><br><span class="line">        Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span><br><span class="line">        Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span><br><span class="line">        Configuration outConfig, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mWindowPlacerLocked.performSurfacePlacement();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 WindowSurfacePlacer.performSurfacePlacement() 中，通过一系列调用后，会通过两次Handler机制，最终调用到<a href="#4.6"> <strong>4.6</strong> </a>中的 ActivityRecord.windowsDrawnLocked();</li>
</ul>
<h4 id="4-9-ViewRootImpl-doTraversal"><a href="#4-9-ViewRootImpl-doTraversal" class="headerlink" title="4.9 ViewRootImpl.doTraversal() "></a>4.9 ViewRootImpl.doTraversal() <span id="4.9"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        ...</span><br><span class="line">        performTraversals();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">            viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">        ...</span><br><span class="line">        performDraw();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>mTraversalScheduled 为true时，会调用 ViewRootImpl.performTraversals()；</li>
<li>ViewRootImpl.relayoutWindow() 中会通过 WindowManagerGlobal.getWindowSession().relayout() 来发起远程调用，最终会调用到<a href="#4.8"> <strong>4.8</strong> </a>中的 WindowManagerService.relayoutWindow()；</li>
</ul>
<h4 id="4-10-ViewRootImpl-scheduleTraversals"><a href="#4-10-ViewRootImpl-scheduleTraversals" class="headerlink" title="4.10 ViewRootImpl.scheduleTraversals() "></a>4.10 ViewRootImpl.scheduleTraversals() <span id="4.10"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!scheduleByHandler) &#123;</span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br></pre></td></tr></table></figure>
<ul>
<li>在<a href="#4.9"> <strong>4.9</strong> </a>中 ViewRootImpl.doTraversal() 方法被调用前，将mTraversalScheduled为false置为true；</li>
<li>调用 Choreographer.postCallback() 发送一个TraversalRunnable对象，其 run() 方法会调用ViewRootImpl.doTraversal()；</li>
<li>Choreographer.postCallback() 中，通过一系列调用后，会调到 DisplayEventReceiver.scheduleVsync()；</li>
<li>而 DisplayEventReceiver.scheduleVsync() 调用后，FrameDisplayEventReceiver.run() 方法会被调度执行，其中会调用到 TraversalRunnable.run() 方法；</li>
</ul>
<h4 id="4-11-WindowManagerImpl-addView"><a href="#4-11-WindowManagerImpl-addView" class="headerlink" title="4.11 WindowManagerImpl.addView()"></a>4.11 WindowManagerImpl.addView()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    applyDefaultToken(params);</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>mGlobal.addView() 中会调用到<a href="#4.10"> <strong>4.10</strong> </a>中的 ViewRootImpl.scheduleTraversals() 方法；</li>
<li>其在整个启动流程中的调用位置在<a href="#2.4.11.2"> <strong>2.4.11(2)</strong> </a>的 ActivityThread.handleResumeActivity() 中；</li>
</ul>
<p>到这里，Activity冷启动流程以及启动时间测试就基本上分析完毕了。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/blog/web/hexo/hexo-basic.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Hexo小记 —— 新手上路</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="android/android-start-activity" data-title="Android7.0 Activity启动流程与App冷启动时间测试源码分析" data-url="http://www.jjmoo.com/blog/android/android-start-activity.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"jjmoo"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Zohn | <a href="http://www.miitbeian.gov.cn/" target="_blank">粤ICP备16037176号</a> |
    	</div>
    	<div class="footer-right">
    		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a>
    	</div>
    </div>
  </div>
</footer>


    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>

<!-- 百度自动推送代码 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</html>
